#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

ROOT_DIR="${ROOT_DIR:-$HOME/.system-config}"
FROM_DIR=""

usage() {
  cat <<'USAGE'
Usage: restore --from DIR
Restores dotfiles, preferences, and colors from a backup directory.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --from) FROM_DIR="${2:-}"; shift ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1"; usage; exit 1 ;;
  esac
  shift
done

export ROOT_DIR

# shellcheck disable=SC1090
source "$ROOT_DIR/lib/common.sh"
source "$ROOT_DIR/lib/dotfiles.sh"
source "$ROOT_DIR/lib/preferences.sh"
source "$ROOT_DIR/lib/colors.sh"

[[ -n "$FROM_DIR" ]] || die "--from is required"
[[ -d "$FROM_DIR" ]] || die "Backup dir not found: $FROM_DIR"

backup_root="$ROOT_DIR/backups/restore-$(timestamp)"
ensure_dir "$backup_root"

log "Restoring dotfiles from $FROM_DIR"
while IFS= read -r file; do
  local_src="$FROM_DIR/dotfiles/$file"
  local_dst="$HOME/$file"

  [[ ! -e "$local_src" ]] && { warn "Missing in backup: $local_src"; continue; }

  if [[ -e "$local_dst" ]]; then
    ensure_dir "$backup_root/$(dirname "$file")"
    run cp -a "$local_dst" "$backup_root/$file"
  fi

  ensure_dir "$(dirname "$local_dst")"
  run cp -a "$local_src" "$local_dst"
done < <(read_dotfiles)

log "Restoring preferences from $FROM_DIR"
if [[ -d "$FROM_DIR/preferences" ]]; then
  PREFERENCES_DIR="$FROM_DIR/preferences"
  PREFERENCES_TARGET="$HOME/Library/Preferences"

  while IFS= read -r -d '' file; do
    local basename="${file#$PREFERENCES_DIR/}"
    local src="$file"
    local dst="$PREFERENCES_TARGET/$basename"

    [[ ! -e "$src" ]] && { warn "Missing in backup: $src"; continue; }

    if [[ -e "$dst" ]]; then
      ensure_dir "$backup_root/preferences/$(dirname "$basename")"
      run cp -a "$dst" "$backup_root/preferences/$basename"
    fi

    ensure_dir "$(dirname "$dst")"
    run cp -a "$src" "$dst"
  done < <(find "$PREFERENCES_DIR" -name "*.plist" -type f -print0)
fi

log "Restoring colors from $FROM_DIR"
if [[ -d "$FROM_DIR/colors" ]]; then
  COLORS_DIR="$FROM_DIR/colors"
  COLORS_TARGET="$HOME/Library/Colors"
  
  ensure_dir "$COLORS_TARGET"
  
  while IFS= read -r -d '' file; do
    local basename="${file#$COLORS_DIR/}"
    local src="$file"
    local dst="$COLORS_TARGET/$basename"
    
    [[ ! -e "$src" ]] && { warn "Missing in backup: $src"; continue; }
    
    if [[ -e "$dst" ]]; then
      ensure_dir "$backup_root/colors/$(dirname "$basename")"
      run cp -a "$dst" "$backup_root/colors/$basename"
    fi
    
    ensure_dir "$(dirname "$dst")"
    run cp -a "$src" "$dst"
  done < <(find "$COLORS_DIR" -name "*.clr" -type f -print0)
fi

note "Restore complete. Previous files backed up to: $backup_root"
